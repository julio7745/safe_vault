<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Vault - Login</title>
    <link rel="stylesheet" type="text/css" href="./main.css">
</head>
<body class="bg-darkBlue">

    <div class="containLogin">
        <div class="loginView">
            
            <div class="header">
                <div class="logoContainer">
                    <img src="logoClara1.svg" class="logo" alt="Logo">
                </div>
                <div class="title text-whiteCustom">Safe Vault</div>
                <div class="text text-whiteCustom">Welcome!</div>
            </div>

            <form id="wifiForm" class="loginForm bg-mediumBlue">
                <div class="titleForm text-whiteCustom">Wi-fi settings (2.4Gb)</div>

                <div class="text-whiteCustom hidden" id="connectingDiv">
                    We are making the connection. please wait!
                </div>
                <div class="text-whiteCustom hidden" id="successDiv">
                    We managed to establish the connection. You can go ahead and close this tab!!
                </div>
                <div class="text-whiteCustom hidden" id="failureDiv">
                    Something went wrong while connecting to this network. Please try again!
                </div>

                <div id="formDiv">
                    <div class="field">
                        <img src="wifi.svg" class="icon bg-whiteCustom">
                        <input type="text" name="networkName" placeholder="Network Name" class="input text-darkBlue" maxlength="35" required >
                    </div>
                    <!-- TODO: vetorizar todas as imagens  -->
                    <div class="field">
                        <img src="password.png" class="icon bg-whiteCustom">
                        <input type="password" name="networkPassword" placeholder="Network Password" class="input text-darkBlue" maxlength="15" required minlength="8">
                        <img src="handleDisplayPassword.png" class="IconPassword bg-whiteCustom" onclick="togglePassword()">
                    </div>
                    <div class="campBtnLogin">
                        <button type="submit" class="btnLogin bg-orangeCustom text-whiteCustom">
                            <img src="submit.svg" class="icon">
                        </button>
                    </div>
                </div>

            </form>

        </div>
    </div>

    <script>

        function togglePassword() {
            const input = document.getElementsByName('networkPassword');
            input[0].type = input[0].type === 'password' ? 'text' : 'password';
        }

        const connectingDiv = document.querySelector('#connectingDiv');
        const successDiv = document.querySelector('#successDiv');
        const failureDiv = document.querySelector('#failureDiv');
        const formDiv = document.querySelector('#formDiv');

        function showConnecting() {
            connectingDiv.classList.remove('hidden');
            successDiv.classList.add('hidden');
            failureDiv.classList.add('hidden');
            formDiv.classList.add('hidden');
        }

        function showSuccess() {
            connectingDiv.classList.add('hidden');
            successDiv.classList.remove('hidden');
            failureDiv.classList.add('hidden');
            formDiv.classList.add('hidden');
        }

        function showFailure() {
            connectingDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            failureDiv.classList.remove('hidden');
            formDiv.classList.remove('hidden');
        }

        function showForm() {
            connectingDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            failureDiv.classList.add('hidden');
            formDiv.classList.remove('hidden');
        }

        document.getElementById('wifiForm').addEventListener('submit', function(e) {
            
            e.preventDefault();

            const formData = new FormData(this);
            const params = new URLSearchParams(formData);

            showConnecting();

            fetch('/wificonfig', {
                method: 'POST',
                body: params
            })
            .then(data => {
                iniciarMonitoramento();
            })
            .catch(error => {
                showFailure();
                console.error('Erro na conexão:', error);
            });

        });

        function iniciarMonitoramento() {
            setInterval(verificarStatusConexao, 3000);
        }

        function verificarStatusConexao() {
            
            fetch('/wificonfigupdate', {
                    method: 'GET'
                })
                .then(response => response.text())
                .then(status => {

                    console.log(status);
                    
                    switch (status) {
                        case "connecting":
                            showConnecting();
                            break;
                        case "success":
                            showSuccess();
                            closeTab();
                            break;
                        case "failure":
                            showFailure();
                            break;
                        default:
                            showFailure();
                            break;
                    }

                })
                .catch(error => {
                    showFailure();
                    console.error('Erro na conexão:', error);
                });
        }

        function closeTab() {
        
            setTimeout(function() {
                window.close();
                window.location.href = "about:blank";
            }, 10000);
        }

    </script>

</body>
</html>